[English](ARCHITECTURE.md) | **Русский**

# 󰙵 Архитектура

Техническая документация архитектуры для Braille Boogie v3.2.

---

## 󰈏 Обзор

```
┌──────────────────────────────────────────────────────────────────┐
│                       Braille Boogie v3.2                         │
├──────────────────────────────────────────────────────────────────┤
│  Аудио слой     FFT слой       Шина управл.    Анимация          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐   │
│  │ PipeWire │───>│ cavacore │───>│  Шина    │───>│ Скелетный│   │
│  │  Pulse   │    │   FFT    │    │ управл.  │    │  танцор  │   │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘   │
│                                         │               │         │
│                                         ├──────────>────┤         │
│                                         │               │         │
│                              ┌──────────┴────┐    ┌────┴──────┐  │
│                              │   Частицы     │    │    UI     │  │
│                              │   Следы       │    │ Реактив.  │  │
│                              │   Фоновые     │    │ Профайлер │  │
│                              └───────────────┘    └───────────┘  │
│                                         │               │         │
│                                         └───────┬───────┘         │
│                                                 │                 │
│                                          ┌──────┴──────┐          │
│                                          │   Брайль    │          │
│                                          │   холст     │          │
│                                          └─────────────┘          │
└──────────────────────────────────────────────────────────────────┘
```

**Архитектура v3.2:**
Аудио → FFT → **Шина управления** → {Скелет, Частицы, Фоновые FX, UI}
- **Шина управления**: Унифицированные сигналы со сглаживанием огибающей
- **Определение жанра**: Автоклассификация стиля для пасхальных поз
- **228 поз**: 13 категорий включая 6 жанровых танцевальных стилей
- **Настраиваемое сглаживание**: Быстрое для танцора, среднее для частиц, медленное для UI

**Качество кода v3.2.4:**
- **cppcheck чисто**: Ноль критических/высоких проблем статического анализа
- **const-корректность**: Указатели только для чтения правильно помечены `const`
- **static-связываемость**: Внутренние функции ограничены единицами трансляции
- **NULL-безопасность**: Все возвраты malloc() проверяются перед использованием

---

## 󰉋 Структура директорий

```
src/
├── 󰈮 main.c                 # Точка входа, главный цикл
├── 󰈮 constants.h            # v3.2: Централизованные константы (~150 параметров)
│
├── 󰎈 audio/                 # Захват аудио
│   ├── pipewire.c          # PipeWire поток (Linux)
│   ├── pulse.c             # PulseAudio захват (Linux)
│   ├── coreaudio.c         # CoreAudio захват (macOS)
│   ├── rhythm.c            # Детекция битов (v2.3)
│   ├── bpm_tracker.c       # v3.0: Продвинутый BPM с уверенностью/стабильностью
│   ├── energy_analyzer.c   # v3.0: RMS-энергия, зоны интенсивности
│   ├── audio_picker.c      # v3.0+: Интерактивный выбор источника
│   └── common.c            # Общие утилиты
│
├── 󰓾 fft/                   # Частотный анализ
│   └── cavacore.c          # FFT (из cava)
│
├── 󱓻 control/               # v2.4: Шина управления
│   └── control_bus.c       # Унифицированные аудио-сигналы
│
├── 󰕮 braille/               # Рендеринг
│   ├── braille_canvas.c    # Пиксель→брайль + сканлайн заливка
│   ├── braille_dancer.c    # Интерфейс
│   └── skeleton_dancer.c   # Физика/позы/ограничения (228 поз)
│
├── 󱐋 effects/               # Визуальные эффекты
│   ├── particles.c         # Система частиц + отталкивание
│   ├── trails.c            # Следы движения
│   ├── background_fx.c     # v3.0: 7 режимов фоновых эффектов
│   └── effects.c           # Менеджер
│
├── 󰎁 export/                # v3.0+: Запись/экспорт
│   └── frame_recorder.c    # Захват кадров для GIF/видео
│
├── 󰍹 render/                # Вывод в терминал
│   ├── render_new.c        # ncurses
│   └── colors.c            # 13 тем (256 цветов)
│
├── 󰌌 ui/                    # v2.4+: Реактивный UI и справка
│   ├── ui_reactive.c       # Пульсация рамки, измеритель энергии
│   ├── help_overlay.c      # Интерактивная справка (? или F1)
│   ├── profiler.c          # v3.0+: Профайлер производительности
│   └── term_caps.c         # v3.0+: Возможности терминала
│
├── 󰚹 dancer/                # API танцора
│   ├── dancer.h            # Заголовок
│   └── legacy/             # v3.2: Архивированный легаси-код
│
└── 󰒓 config/                # Конфигурация
    └── config.c            # INI парсер
```

---

## 󰔏 Аудио-конвейер

**Модель потоков:**
```
┌─────────────────┐     ┌─────────────────┐
│   Главный поток │     │  Аудио-поток    │
│  - Обработка FFT│◄────│  - PW/PA/CA     │
│  - Анимация     │     │  - Запись семплов│
│  - Рендеринг    │     └─────────────────┘
└─────────────────┘
```

**Аудио-бэкенды:**
- **Linux:** PipeWire (предпочтительно) или PulseAudio
- **macOS:** CoreAudio (AudioQueue API)

**Поток:** Аудио → Кольцевой буфер → FFT → 256 бинов → бас/средние/высокие

---

## 󰚹 Система скелета

**15 суставов:**
```
          ГОЛОВА
           │
    ПЛЕЧО──┼──ПЛЕЧО
        │ПОЗВОНОЧНИК│
      ЛОКОТЬ  │   ЛОКОТЬ
        │     │     │
      КИСТЬ БЕДРО  КИСТЬ
          ┌─┼─┐
        БЕДРО БЕДРО
         │     │
      КОЛЕНО  КОЛЕНО
         │     │
       СТОПА  СТОПА
```

**Физика:** Пружинно-демпферная система на сустав
- Жёсткость: 0.1-0.5
- Демпфирование: 0.7-0.9

**228 поз** в 13 категориях:
| Категория | Диапазон энергии | Количество |
|-----------|------------------|------------|
| IDLE | 0.00-0.15 | 4 |
| CALM | 0.15-0.35 | 5 |
| GROOVE | 0.35-0.55 | 8 |
| ENERGETIC | 0.55-0.75 | 7 |
| INTENSE | 0.75-1.00 | 6 |
| BASS_HIT | Транзиент | 4 |
| TREBLE_ACCENT | Транзиент | 4 |
| MOONWALK | Хип-хоп/Поп | 4 |
| BALLET | Классика | 5 |
| BREAKDANCE | Хип-хоп | 4 |
| WALTZ | Классика | 4 |
| ROBOT | Электроника | 5 |
| HEADBANG | Рок | 4 |

**Определение жанра (v3.2):**
- Электроника: Высокий treble ratio, быстрый BPM → Робот-позы
- Хип-хоп: Сильный бас, средний темп → Лунная походка, Брейк-данс
- Рок: Высокая энергия, гитарный диапазон → Хедбэнг
- Классика: Низкая энергия, баланс → Балет, Вальс
- Поп: Баланс, ровный бит → Лунная походка
- Пасхалки срабатывают ~15% времени при определении жанра

---

## 󰕮 Брайль-холст

**Разрешение:** 50×52 пикселя → 25×13 ячеек терминала

**Кодирование:** Unicode U+2800-U+28FF (8 точек на символ)
```
┌─┬─┐
│1│4│  Биты: 0x01, 0x08
├─┼─┤
│2│5│  Биты: 0x02, 0x10
├─┼─┤
│3│6│  Биты: 0x04, 0x20
├─┼─┤
│7│8│  Биты: 0x40, 0x80
└─┴─┘
```

**Примитивы рисования:**
- `braille_draw_line()` — Алгоритм Брезенхэма
- `braille_draw_circle()` — Срединная окружность
- `braille_draw_bezier_quad()` — Квадратичные кривые
- `braille_draw_bezier_cubic()` — Кубические кривые
- `braille_flood_fill()` — Сканлайн алгоритм (v3.2: ограниченная очередь O(4096))

---

## 󱐋 Система эффектов (v3.0)

### 󰸞 Частицы
- Пул из 256 частиц (без аллокаций)
- Физика: скорость, гравитация, сопротивление
- Паттерны спавна: burst, fountain, explosion, sparkle
- Затухание по времени жизни

### 󰘵 Следы движения
- Кольцевой буфер на сустав (8 позиций)
- Запись на основе скорости
- Затухание альфы со временем

### 󱐋 Фоновые эффекты (v3.0)
7 эффектных режимов:
| Режим | Описание |
|-------|----------|
| Эмбиент-поле | Плавающие мерцающие частицы |
| Спектральные волны | Частотно-реактивные импульсы |
| Энергетическая аура | Пульсирующее кольцо вокруг танцора |
| Ударный взрыв | Синхронизированные с битами взрывы |
| Частотные ленты | Вертикальные частотные полосы |
| Дождь частиц | Падающие частицы сверху |
| Спиральный вихрь | Вращающиеся спиральные рукава |

---

## 󰓾 Конвейер рендеринга

```
1. Захват аудио (поток)
        ↓
2. FFT → частотные бины
        ↓
3. Расчёт бас/средние/высокие
        ↓
4. Обновление физики скелета
        ↓
5. Триггеры эффектов (бас→частицы и т.д.)
        ↓
6. Очистка холста
        ↓
7. Рендер следов → холст
        ↓
8. Рендер скелета → холст
        ↓
9. Рендер частиц → холст
        ↓
10. braille_canvas_render() → преобразование пикселей в ячейки
        ↓
11. braille_canvas_to_utf8() → UTF-8 строка
        ↓
12. ncurses mvprintw() → терминал
```

---

## 󰾆 Производительность

- **60 FPS** — цель (~16.6мс на кадр)
- **Пул частиц** — фиксированный массив, без malloc
- **Отслеживание грязных ячеек** — пропуск неизменённых
- **8× сжатие** — брайль упаковывает 8 пикселей/символ
- **Однопоточный рендер** — простота важнее параллелизма

---

## 󰒓 Конфигурация

**Файл:** `~/.config/braille-boogie/config.ini`

```ini
[audio]
source = auto
backend = pipewire
sensitivity = 1.0

[visual]
theme = matrix
ground = true
shadow = true
particles = true
trails = true

[animation]
fps = 60
```

---

## 󱓻 Шина управления (v2.4)

**Архитектура унифицированных сигналов:**

Шина управления отделяет аудиоанализ от анимации, предоставляя нормализованные сигналы 0-1 с настраиваемым сглаживанием атаки/релиза.

```c
typedef struct {
    SmoothedValue energy;    // RMS громкость
    SmoothedValue bass;      // 20-300 Гц
    SmoothedValue mid;       // 300-2000 Гц
    SmoothedValue treble;    // 2000+ Гц
    SmoothedValue onset;     // Детекция транзиентов
    BeatState beat;          // Фаза, удар, BPM
} ControlBus;
```

**Пресеты сглаживания:**
| Пресет | Атака | Релиз | Применение |
|--------|-------|-------|------------|
| FAST | 5мс | 50мс | Анимация танцора |
| MEDIUM | 10мс | 100мс | Эмиссия частиц |
| SLOW | 20мс | 200мс | Отображение UI |
| INSTANT | 0мс | 0мс | Отладка/сырые значения |

---

## 󰘦 Ключевые алгоритмы

### Детекция битов
```c
if (bass > threshold && bass_velocity > min_velocity) {
    trigger_bass_hit();
}
```

### Ограничение колен (v2.4)
```c
// Предотвращение «косолапости»
float cx = hip_center.x;
bool left_planted = (beat_phase < 0.5f);

if (knee_left.x > cx - knee_offset && left_planted) {
    knee_left.x = cx - knee_offset;  // Отталкивание наружу
    velocity.x *= -0.3f;             // Отскок
}
```

### Выбор позы
```c
// Избегание недавних поз, выбор из категории энергии
Category cat = energy_to_category(energy);
do {
    pose = random_from_category(cat);
} while (in_recent_history(pose));
```

### Пружинно-демпферная физика
```c
force = (target - position) * stiffness;
velocity += force;
velocity *= damping;
position += velocity * dt;
```

### Определение жанра (v3.2)
```c
// Классификация жанра по аудио-характеристикам
GenreStyle detect_genre(float bass_ratio, float treble_ratio, 
                        float energy, float bpm) {
    if (treble_ratio > 0.4f && bpm > 120)
        return GENRE_ELECTRONIC;
    if (bass_ratio > 0.45f && bpm >= 80 && bpm <= 115)
        return GENRE_HIPHOP;
    if (energy > 0.6f && treble_ratio > 0.3f)
        return GENRE_ROCK;
    if (energy < 0.3f)
        return GENRE_CLASSICAL;
    return GENRE_POP;
}
```

---

## 󰈮 Заголовок констант (v3.2)

Централизованные параметры настройки в `constants.h`:

```c
// Отслеживание BPM
#define BPM_MIN                 40
#define BPM_MAX                 240
#define BPM_LOCK_CONFIDENCE     0.7f
#define BPM_LOCK_STABILITY      0.85f

// Пороги энергии
#define ENERGY_SILENT           0.02f
#define ENERGY_LOW              0.15f
#define ENERGY_MEDIUM           0.35f
#define ENERGY_HIGH             0.55f
#define ENERGY_PEAK             0.75f

// Тайминг анимации
#define POSE_TRANSITION_FAST    0.15f
#define POSE_TRANSITION_NORMAL  0.25f
#define POSE_TRANSITION_SLOW    0.4f

// Физика
#define JOINT_STIFFNESS         0.15f
#define JOINT_DAMPING           0.85f
#define BREATHING_AMPLITUDE     0.02f
```

---

## 󰾆 Профайлер производительности (v3.0+)

Потокобезопасный тайминг с атомарными операциями:

```c
// Потокобезопасный тайминг кадра
static _Atomic double frame_start_time = 0.0;

void profiler_frame_start(void) {
    atomic_store(&frame_start_time, get_time_ms());
}

double profiler_get_frame_time(void) {
    return get_time_ms() - atomic_load(&frame_start_time);
}
```

**Отслеживаемые метрики:**
- Текущий/средний/мин/макс FPS
- Время обработки аудио
- Время цикла обновления
- Время цикла рендера
- Количество частиц
- Количество следов
