[English](CHANGELOG.md) | **Русский**

# Журнал изменений

Все значимые изменения в ASCII Dancer будут задокументированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Семантическому версионированию](https://semver.org/lang/ru/).

## 󰧹 v3.2.4 - Очистка статического анализа (Январь 2026)

### 󱪚 Критические исправления
- **NULL-безопасность** — cavacore.c malloc() теперь проверяется перед разыменованием
- **Затенение переменных** — main.c sw/sh переименованы для избежания затенения во внутренней области

### 󰧹 Const-корректность
- **15+ функций** обновлены с параметрами `const` указателей
- Файлы: cavacore, particles, trails, frame_recorder, help_overlay, profiler, skeleton_dancer, config

### 󰒓 Static-связываемость
- **20+ внутренних функций** помечены `static` для уменьшения засорения таблицы символов
- Добавлены предварительные объявления где необходимо
- Статические функции удалены из публичных заголовков

### 󱁤 cppcheck чисто
- Ноль критических/высоких проблем
- Сборка проходит `cppcheck --enable=all` только со стилевыми предупреждениями в легаси-коде

---

## 󰆍 v3.2.3 - Улучшения системы сборки (Январь 2026)

### 󰆍 Улучшения Makefile
- **Встраивание версии** — VERSION, GIT_HASH, BUILD_DATE через $(shell ...) в бинарник
- **make help** — Показывает все доступные цели сборки
- **make info** — Отображает конфигурацию сборки (ОС, компилятор, аудио-бэкенды)
- **make run** — Собрать брейль-танцора и сразу запустить
- **make debug** — Сборка с -O0 -DDEBUG и запуск в gdb

### 󰣇 Поддержка macOS (v3.2.2)
- **Бэкенд CoreAudio** — Нативный захват звука через AudioQueue API
- **Кросс-платформенный Makefile** — Автоматическое определение Darwin/Linux
- **Пути Homebrew** — Поддержка ncurses для Apple Silicon и Intel

### 󰧹 Качество кода (v3.2.1)
- **Потокобезопасный профайлер** — _Atomic для кросс-потокового тайминга
- **Централизованные константы** — constants.h с ~150 параметрами настройки
- **Заливка сканлайнами** — Ограниченное выделение памяти O(4096)

---

## 󰝚 v3.2.0 - Танцевальная революция (Январь 2026)

### 󰛿 Новые танцевальные стили
- **Лунная походка** — 4 плавных скольжения назад со стойками на носках
- **Балет** — 5 классических поз включая арабеск, плие и релеве
- **Брейк-данс** — 4 пауэр-мува с топроками, фризами и подготовительными стойками
- **Вальс** — 4 элегантные бальные позиции с рамками и поворотами
- **Робот** — 5 механических движений с локами, изоляциями и экстеншенами
- **Хедбэнг** — 4 рок-позы с мощными стойками и «рогами»

### 󰎈 Улучшенное определение жанра
- **Поп-стиль** — Новая категория музыкального стиля для сбалансированных треков с ровным битом
- **Пасхальные триггеры** — Особые жанровые движения срабатывают случайно (~15% шанс)
- **Улучшенные пороги** — Лучшее определение электроники, хип-хопа, рока, классики
- **Жанр-поза соответствие** — Электроника → Робот, Хип-хоп → Лунная походка/Брейк-данс, Классика → Балет/Вальс, Рок → Хедбэнг

### 󰄧 Расширение системы поз
- **228 базовых поз** — Рост с 36 поз (6× увеличение)
- **~1,190 вариаций** — Включая процедурное отзеркаливание и модификации
- **13 категорий поз** — Добавлено 6 новых жанровых категорий
- **Антиповторение** — По-прежнему избегает последних 8 поз для разнообразия

### 󰃢 Очистка кода
- **Легаси-код архивирован** — Перемещено 9 неиспользуемых файлов (~1,342 строки) в `src/dancer/legacy/`
- **Удалены стаб-функции** — Очищен нефункциональный код визуализатора
- **Сохранена совместимость API** — Стаб-функции оставлены для существующих интеграций

### 󰈙 Технически
- Изменено: `src/braille/skeleton_dancer.h` — Добавлено 6 категорий поз, перечисление STYLE_POP
- Изменено: `src/braille/skeleton_dancer.c` — Добавлено 26 новых базовых поз, улучшено определение жанра
- Изменено: `src/braille/braille_dancer.c` — Удалена реализация визуализатора
- Архивировано: 9 легаси-файлов → `src/dancer/legacy/`

---

> 󰀨 **Примечание:** Проект находится в ранней разработке и может содержать ошибки.

---

## 󰒓 v3.0.1 - Продакшн-инструменты (Январь 2026)

### 󰎁 Запись и экспорт кадров
- **Рекордер кадров** — Захват терминальных кадров в директории с временными метками
- **Экспорт ANSI-текста** — Сохранение цветов для постобработки
- **Рабочий процесс GIF/видео** — Совместимость с asciinema, agg или vhs
- Нажмите `x` для начала/остановки записи

### 󰄧 Профайлер производительности
- **FPS в реальном времени** — Текущий, средний, мин, макс
- **Тайминг компонентов** — Разбивка аудио, обновления, рендера в мс
- **Счётчики частиц/следов** — Мониторинг объектов в реальном времени
- **Визуальная шкала производительности** — Индикаторы зелёной/жёлтой/красной зоны
- Нажмите `i` для переключения оверлея профайлера

### 󰎈 Выбор аудиоисточника
- **Интерактивное меню** — Стрелки для выбора источника звука
- **PulseAudio/PipeWire** — Перечисление доступных источников
- Запуск с флагом `--pick-source`

### 󰍹 Определение возможностей терминала
- **Sixel графика** — Определение поддержки растровой графики
- **Протокол Kitty** — Проверка графики терминала Kitty
- **iTerm2 inline** — Определение протокола изображений iTerm2
- **True color** — Проверка поддержки 24-битного цвета
- Запуск с флагом `--show-caps`

### 󰈙 Новые элементы управления
| Клавиша | Действие |
|---------|----------|
| `f` | Переключить фоновые эффекты |
| `e` | Циклическое переключение типов эффектов (7 режимов) |
| `x` | Переключить запись кадров |
| `i` | Переключить профайлер производительности |

### 󰈙 Новые CLI-флаги
| Флаг | Описание |
|------|----------|
| `--pick-source` | Интерактивный выбор аудиоисточника |
| `--show-caps` | Показать возможности терминала |

### 󰈙 Технически
- Новые файлы: `src/export/frame_recorder.h/.c` (~200 строк)
- Новые файлы: `src/audio/audio_picker.h/.c` (~180 строк)
- Новые файлы: `src/ui/term_caps.h/.c` (~120 строк)
- Новые файлы: `src/ui/profiler.h/.c` (~180 строк)
- Обновлено: `src/main.c` (интеграция v3.0+)
- Обновлено: `Makefile` (переменная V30P_SRCS)
- Документация: `docs/V3_FEATURES.md` полное руководство
- Всего нового кода: ~680 строк

---

## 󱐋 v3.0 - Большое аудио-обновление (Январь 2026)

### 󰾆 Продвинутый BPM-трекер
- **Мульти-тап усреднение темпа** — Анализ нескольких интервалов битов с гистограммной кластеризацией
- **Оценка уверенности (0-1)** — Показывает надёжность оценки BPM
- **Отслеживание стабильности** — Измеряет постоянство темпа во времени
- **Фиксация темпа** — Высокая уверенность + высокая стабильность = зафиксированный темп
- **Определение половинного/двойного темпа** — Идентификация альтернативных интерпретаций
- **Диапазон 40-240 BPM** — Шире оригинального 60-200
- **Адаптивное отслеживание** — Плавная обработка постепенных изменений темпа

### 󰄧 Динамический анализатор энергии
- **Расчёт RMS-энергии** — Измерение среднеквадратичной мощности
- **Детекция пиков** — Отслеживание максимальной амплитуды
- **Зоны интенсивности** — Тишина, Низкая, Средняя, Высокая, Пик
- **Огибающий фильтр** — Сглаживание атаки/релиза для плавной визуализации
- **Спектральные характеристики** — Центроид (яркость), разброс, спад
- **Анализ динамического диапазона** — Пик vs RMS в дБ
- **Интенсивность темпа** — Комбинированная метрика BPM + энергия
- **Адаптивные пороги** — Самонастраивающиеся границы зон на основе истории
- **6-полосное отслеживание энергии** — От суб-баса до высоких

### 󰸞 Эффектные фоновые эффекты
7 режимов эффектов на частицах:
- 󰸞 **Эмбиент-поле** — Плавающие мерцающие частицы
- 󰘸 **Спектральные волны** — Частотно-реактивные импульсы снизу
- 󰝁 **Энергетическая аура** — Пульсирующее кольцо вокруг танцора
- 󰛲 **Ударный взрыв** — Взрывы синхронизированные с битами (с кулдауном)
- 󰄧 **Частотные ленты** — Вертикальные частотные полосы
- 󰖐 **Дождь частиц** — Падающие частицы сверху
- 󰜁 **Спиральный вихрь** — Вращающиеся спиральные рукава

Все эффекты включают:
- Регулировку интенсивности (0-1)
- Управление скоростью
- Полную аудиореактивность (частотные полосы, энергия, биты)
- Интеграцию с существующей 256-частичной системой

### 󰈙 Технически
- Новые файлы: `src/audio/bpm_tracker.h`, `src/audio/bpm_tracker.c` (~270 строк)
- Новые файлы: `src/audio/energy_analyzer.h`, `src/audio/energy_analyzer.c` (~380 строк)
- Новые файлы: `src/effects/background_fx.h`, `src/effects/background_fx.c` (~460 строк)
- Обновлено: `Makefile` (переменная V30_SRCS для новых модулей)
- Всего нового кода: ~1,540 строк

---

## 󰏘 v2.4+ - Справка и темы (Январь 2026)

### 󰐕 Новые возможности
- **Интерактивный оверлей справки** — Нажмите `?` или `F1` для переключения
  - Показывает все горячие клавиши по категориям
  - Отображение статуса в реальном времени (тема, BPM, чувствительность, активные эффекты)
  - Плавная анимация появления/исчезновения
  - Чистый UI с символами рисования рамок Unicode

- **6 новых цветовых тем** — Расширено с 7 до 13 тем
  - **Aurora** 󱝂 — Северное сияние (зелёный→бирюзовый→синий→фиолетовый)
  - **Sunset** 󰖛 — Тёплое вечернее небо (оранжевый→розовый→фиолетовый)
  - **Ocean** 󰘸 — Глубоководная атмосфера (тёмно-синий→бирюзовый→аквамарин)
  - **Candy** 󰄛 — Мягкие пастельные тона (розовый→мятный→лавандовый)
  - **Vapor** 󱥒 — Интенсивный вейпорвейв (ярко-розовый→голубой→фиолетовый)
  - **Ember** 󰈸 — Тлеющие угли (тёмно-красный→оранжевый→жёлтый)

### 󰒓 Улучшения
- Циклическое переключение тем теперь использует перечисление `THEME_COUNT`
- Улучшенные описания тем с эмодзи-индикаторами
- Текст использования обновлён для показа 13 доступных тем
- Все темы используют 256-цветную палитру xterm для плавных градиентов

### 󰈙 Технически
- Новые файлы: `src/ui/help_overlay.h`, `src/ui/help_overlay.c`
- Обновлено: `src/config/config.h` (добавлено 6 перечислений тем + THEME_COUNT)
- Обновлено: `src/config/config.c` (парсинг имён тем)
- Обновлено: `src/render/colors.c` (6 новых реализаций тем, ~130 строк каждая)
- Обновлено: `src/main.c` (интеграция справочного оверлея)
- Makefile: Добавлено `help_overlay.c` в V24_SRCS

---

## 󰱒 v2.4 - Полировка и UX (Январь 2026)

### 󱐋 Новые модули
- **Шина управления** — Унифицированные аудио-сигналы со сглаживанием огибающей атаки/релиза
  - Базовые сигналы: energy, bass, mid, treble (нормализованные 0-1)
  - Детекция транзиентов: onset-сигнал от производной энергии
  - Отслеживание битов: beat_phase, импульс beat_hit, флаги on_beat/on_half_beat
  - Производные сигналы: brightness, dynamics, bass_ratio, treble_ratio
  - Детекция тишины с настраиваемым порогом и дебаунсингом
  - Настраиваемые пресеты сглаживания (FAST, MEDIUM, SLOW, INSTANT)

- **UI-реактивность** — Терминально-безопасные реактивные UI-элементы только через плотность глифов
  - Пульсация рамки на бите (4 уровня интенсивности: ─ ━ ▬ █)
  - Шкала энергии с удержанием пика
  - Индикатор фазы бита (анимированный ○◔◑◕●)
  - Мини 3-полосный спектр (bass/mid/treble)
  - Отображение BPM с медленным сглаживанием

### 󰏫 Улучшения скелета
- **Система ограничений колен** — Предотвращает «косолапость» во время анимации
  - Определяет центральную линию по центру бёдер
  - Левое колено ограничено слева от центра, правое — справа
  - Определение стойки по beat_phase: [0-0.5]=левая опорная, [0.5-1]=правая опорная
  - Опорная нога имеет строгое ограничение, маховая — расслабленное
  - Реверс скорости отскока при нарушении ограничения

- **Отслеживание границ тела** — Ограничивающий прямоугольник в реальном времени для исключения частиц
  - `skeleton_dancer_get_bounds()` — нормализованные координаты
  - `skeleton_dancer_get_bounds_pixels()` — пиксельные координаты
  - Кэшированные границы обновляются каждый кадр

### 󱐋 Улучшения частиц
- **Эмиссия по шине управления** — Частицы реагируют на унифицированные управляющие сигналы
  - `particles_emit_controlled()` — спавн на основе onset + энергии
  - Количество масштабируется по onset + энергии
  - Радиус разброса масштабируется по энергии
  - Скорость масштабируется по onset
  - Время жизни обратно масштабируется по энергии (быстрый распад при высокой энергии)

- **Отталкивание наружу** — Частицы отталкиваются от центра танцора
  - `particles_set_repulsion()` — настраиваемая сила отталкивания
  - Частицы активно избегают центра тела при движении
  - Мягкий дрейф наружу для частиц вблизи тела
  - Сила отталкивания по умолчанию: 60.0

### 󰏫 Технически
- Новые файлы: `src/control/control_bus.h`, `src/control/control_bus.c`
- Новые файлы: `src/ui/ui_reactive.h`, `src/ui/ui_reactive.c`
- Обновлено: `src/braille/skeleton_dancer.c`, `src/braille/skeleton_dancer.h`
- Обновлено: `src/effects/particles.c`, `src/effects/particles.h`
- Makefile: Переменная V24_SRCS для новых исходных файлов
- Архитектура: Разделение ответственности — audio → control bus → animation/effects/UI

---

## 󰎔 v2.3 - Аудио-апгрейд (Январь 2026)

### 󱐋 Новые возможности
- **Детекция onset по спектральному потоку** — более точное определение битов
- **Оценка BPM** — Отслеживание темпа на основе автокорреляции
- **Отслеживание фазы бита** — Предвосхищение битов, синхронизация с ритмом
- **Расширенные частотные полосы** — Суб-бас, низкие-средние, высокие-средние

### 󰏫 Улучшения
- Более точный отклик ритма в анимациях
- Переходы поз синхронизированные с битами
- Модификаторы синхронизированные с фазой (bounce, sway)
- Уменьшенное сглаживание для более резких движений
- Отображение BPM в статус-баре

---

## [2.2.0] - 2026-01-18

### Добавлено
- 󰸞 **Система частиц** — Динамические визуальные эффекты
  - Искры на басовых ударах из ног танцора
  - Физическая симуляция (скорость, гравитация, сопротивление)
  - Время жизни частиц с затуханием
  - Множество паттернов спавна (burst, fountain, explosion, sparkle)
  - Переключение клавишей `p`

- 󰘵 **Следы движения** — Эффект призрака при движении
  - Хранит историю позиций суставов
  - Рисует призрачные конечности с затуханием непрозрачности
  - Интенсивность следов на основе скорости
  - Переключение клавишей `m`

- 󱐋 **Визуальные улучшения**
  - Анимация дыхания (тонкое движение в покое)
  - Вибрация пола на сильном басе
  - Тряска экрана на интенсивных басовых ударах
  - Эффект свечения при высокой энергии
  - Переключение дыхания клавишей `b`

### Технически
- Новая директория: `src/effects/`
- Новые файлы: `particles.h/c`, `trails.h/c`, `effects.h/c`
- Добавлен вызов `braille_canvas_render()` для правильного преобразования пиксель→ячейка
- Преобразование координат суставов (нормализованные → пиксельное пространство)
- Эффекты автоматически срабатывают от аудиоанализа

### Исправлено
- Рендеринг частиц теперь правильно конвертирует пиксельный буфер в брайль-символы
- Позиции суставов корректно трансформируются для системы эффектов

---

## [2.1.0] - 2026-01-19

### Добавлено
- 󰏘 **256-цветная система тем** — Богатая визуальная кастомизация
  - 7 встроенных тем: Default, Fire, Ice, Neon, Matrix, Synthwave, Mono
  - 10-ступенчатые цветовые градиенты на основе уровня энергии
  - Циклическое переключение тем клавишей `t` во время воспроизведения
  - CLI-опция `--theme <имя>`

- 󰒓 **Система конфигурации** — Постоянные настройки через INI-файлы
  - Автозагрузка из `~/.config/braille-boogie/config.ini`
  - Секции: [audio], [visual], [terminal], [animation], [debug]
  - CLI-опция `--config <файл>` для пользовательских путей
  - `config_create_default()` генерирует примерную конфигурацию

- 󰈄 **Линия земли и тень** — Улучшенная визуальная глубина
  - Горизонтальная линия земли под ногами танцора
  - Эффект тени/отражения (инвертированный, затенённый танцор под землёй)
  - Переключение земли клавишей `g`, тени клавишей `r`
  - CLI-опции `--no-ground` и `--no-shadow`

- 󰍹 **Адаптивное масштабирование терминала** — Динамическая обработка изменения размера
  - Обработчик SIGWINCH для определения изменения размера терминала
  - Автоматическое перемасштабирование холста под новые размеры
  - Сохранение соотношения сторон при изменении размера

### Изменено
- Система рендеринга рефакторинг для поддержки 256 цветов
- Главный цикл обновлён с интеграцией конфигурации
- Справка теперь показывает список тем

### Технически
- Новые файлы: `src/config/config.h`, `src/config/config.c`
- Новые файлы: `src/render/colors.h`, `src/render/colors.c`
- Обновлено: `src/render/render_new.c`, `src/render/render.h`, `src/main.c`
- Использует 256-цветную палитру xterm (цветовой куб + градации серого)

---

## [2.0.0] - 2026-01-18

### Добавлено
- 󰚹 **Брайль-скелетный танцор** — Полное переписывание с процедурной анимацией
  - 36 уникальных поз в 7 категориях энергии
  - Физика суставов на основе пружинно-демпферной системы
  - Плавная интерполяция через функции сглаживания (квадратичная, кубическая, отскок, эластичная)
  - Инерция и следование для естественного движения

- 󰕮 **Система брайль-холста** — Высокоразрешающая терминальная графика
  - Преобразование пиксель→брайль (разрешение 2×4 субпикселя на ячейку)
  - Примитивы рисования: линии, круги, заполненные круги, дуги
  - Квадратичные и кубические кривые Безье для плавных конечностей
  - Поддержка толстых линий для частей тела

- 󰎈 **Продвинутый аудиоанализ**
  - Детекция битов с оценкой BPM
  - Классификация стиля/жанра (электроника, рок, хип-хоп, эмбиент, классика)
  - Частотно-специфичное маппирование тела (бас→ноги, средние→торс, высокие→руки)

- 󰔶 **Умная система анимации**
  - История поз антиповторения (избегает последних 8 поз)
  - Выбор категории на основе энергии
  - Детекция транзиентов для мгновенных реакций
  - Плавное смешивание между позами

### Технически
- Новые файлы: `src/braille/braille_canvas.h`, `src/braille/braille_canvas.c`
- Новые файлы: `src/braille/skeleton_dancer.h`, `src/braille/skeleton_dancer.c`
- Новые файлы: `src/braille/braille_dancer.c`
- 15-суставной скелет с иерархической костной структурой

---

## [1.0.0] - 2026-01-17

### Добавлено
- Первоначальный релиз
- Кадровый ASCII-танцор с 36 позами
- Захват звука через PipeWire и PulseAudio
- Интеграция обработки FFT через cavacore
- Рендеринг терминала через ncurses
- Базовый анализ частотных полос (бас, средние, высокие)
